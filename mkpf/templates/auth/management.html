{% extends 'new_template.html' %}

{% block style %}
table {
  border-collapse: collapse;
  border-spacing: 0;
  width: 100%;
  border: 1px solid #ddd;
}

{% endblock %}


{% block content %}
<!-- Property Details Section Begin -->
<section class="property-details-section">

    <div class="container" style="margin-top:60px;">
        <div class="row">
            <div class="col-lg-12">
                <div class="pd-text">
                    <div class="pd-widget">
                            <h4>회원관리</h4>

                        </div>
                    <div style="overflow-x:auto; overflow-y:visible;">
                        {% include "form_errors.html" %}
                    <table class="table table-hover">
                        <thead>
                        <tr align="center">
                            <th scope="col">Id</th>
                            <th scope="col">Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Roles</th>

                            {% if g.user.roles == "admin" or g.user.roles == "manager" %}
                             <th scope="col">Update</th>
                            <th scope="col">Delete</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users%}
                        {% if g.user.roles !='admin' %}

                        {% else %}
                        {% endif %}
                        <tr align="center">
                            <th scope="row">{{loop.index}}</th>
                            <td>{{user.username}}</td>
                            <td>{{user.email}}</td>
                            <td>{{user.roles | roles}}</td>
                            {% if g.user.roles == "admin" or g.user.roles == "manager" %}

                            <td><button class="btn btn-sm btn-outline-dark" name="modify">수정</button></td>
                            <td><button onclick="$(this).DeleteBtn();" class="btn btn-sm btn-outline-danger" data-uri="{{ url_for('auth.delete',user_id=user.id)}}">삭제</button></td>
                            {% endif %}
                        </tr>
                        <tr class="table-hover table-secondary" align="center" data-name="modify_form" style="display:none;">
                            <td></td>
                                <td><input {% if g.user.roles =='admin' %}{% else %} disabled {% endif %} type="text" class="form-control" name="cur_username" value="{{ user.username }}"></td>
                                <td><input {% if g.user.roles =='admin' %}{% else %} disabled {% endif %} type="email" class="form-control" name="cur_email" value="{{ user.email }}"></td>
                                <td>

                                    <select class="custom-select" name="cur_roles" id="{{user.id}}">
                                        {% for item in form.roles %}
                                        <option {% if g.user.roles !='admin' and item.data =='admin' %} disabled {% else %} {% endif %} value={{item.data}}>{{item.label}}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><button onclick="$(this).PostForm('{{user.id}}');" type="submit" class="btn btn-sm btn-outline-dark">변경하기</button></td>
                                <td><button type="reset" class="btn btn-sm btn-outline-danger" name="modify-cancel">취소하기</button></td>

                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="modifyform">
        {{ form.csrf_token }}
        <input hidden type="text" name="username"  id="username" value="{{ form.username.data or '' }}">
        <input hidden type="email" name='email' id="email" value="{{ form.email.data or '' }}" >
        <input hidden value="{{form.roles.data or ''}}" id="roles" name="roles">
        <button hidden type="submit"></button>
    </form>
</section>
<!-- Property Details Section End -->
{% endblock %}

{% block script%}

<script type='text/javascript'>
$.fn.DeleteBtn = function() {
        if (confirm('정말 삭제하시겠습니까?')){
        location.href= $(this).data('uri');


        } else {
            alert("삭제를 취소했습니다.");
        }
};
$.fn.PostForm = function(code) {

        if (confirm('Name : '+$("#username").val()+'\nEmail : '+$("#email").val()
        +'\nRoles : '+$("#roles").val() + "\n이대로값을 넣습니다. 진행하겠습니까?")) {
            // 확인 버튼 클릭 시 동작

            $("#modifyform").submit();
        } else {
            // 취소 버튼 클릭 시 동작
            alert("동작을 취소했습니다.");
        }
    };
$(document).ready(function(){

    $("button[name=modify]").on('click', function() {
        var modify_index = $("button[name=modify]").index(this);
        $("#roles").val('');
        $("#username").val('');
        $("#email").val('');

        if($("tr[data-name=modify_form]").eq(modify_index).css("display") == "none"){
            $("tr[data-name=modify_form]").hide();

            $("tr[data-name=modify_form]").eq(modify_index).fadeIn(500);

        }else {
            $("tr[data-name=modify_form]").eq(modify_index).fadeOut(500);
        }
    });

    $("button[name=modify-cancel]").on('click', function() {
        $("tr[data-name=modify_form]").fadeOut(500);
        $("#roles").val('');
        $("#username").val('');
        $("#email").val('');
    });

    $("select[name=cur_roles]").on('change', function() {
        $("#roles").val($(this).val());
        var choice = $("select[name=cur_roles]").index(this);

        $("#code").val($(this).attr('id'));

        $("#username").val($("input[name=cur_username]").eq(choice).attr('value'));
        $("#email").val($("input[name=cur_email]").eq(choice).attr('value'));

    });


});
</script>
{% endblock %}